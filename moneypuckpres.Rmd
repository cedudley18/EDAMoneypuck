---
title: "Initial Tasks with Moneypuck Data"
output: 
  xaringan::moon_reader:
    css: xaringan-themer.css
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  
    fig.width = 9, fig.height = 3.5, fig.retina = 3,
    out.width = "100%",
    cache = FALSE,
    echo = FALSE,
    message = FALSE,
    warning = FALSE,
    fig.show = TRUE,
    hiline = TRUE)
```

```{r xaringan-themer, include = FALSE, warning = FALSE}
library(xaringanthemer)
style_mono_accent(base_color = "#808080",
  white_color = "#FFFFFF",
  background_color = "#fff7e6",
  base_font_size = "24px"
)
```
---
# Bootstrapping
 - Any test or metric that uses sampling with replacement
 - Assigns measures of accuracy to sample estimates
 - Allows estimation of sampling distribution of any statistic using random sampling
 
---


```{r include = FALSE, warning = FALSE}
# for setting up data
library(tidyverse)
shots2020 <- read_csv("shots_2020.csv")
```

```{r}
shots2020 <-
  shots2020 %>%
  mutate(Position = ifelse(playerPositionThatDidEvent == "D", "D", "F"))
```


```{r include = FALSE, warning = FALSE}
# Subsets for calibration
hometeam <- subset(shots2020, team == "HOME")
awayteam <- subset(shots2020, team = "AWAY")
evenstrength <-  shots2020 %>%
  filter(homeSkatersOnIce == 5,
        awaySkatersOnIce == 5)
powerplay <-  shots2020 %>%
  filter(homeSkatersOnIce == 5,
         awaySkatersOnIce == 4,
         isHomeTeam == 1)
penaltykill <-  shots2020 %>%
  filter(homeSkatersOnIce == 4,
         awaySkatersOnIce == 5,
         isHomeTeam == 1)
backhand <- shots2020 %>%
  filter(shotType == "BACK")
deflection <- shots2020 %>%
  filter(shotType == "DEFL")
slapshot <- shots2020 %>%
  filter(shotType == "SLAP")
snapshot <- shots2020 %>%
  filter(shotType == "SNAP")
tip <- shots2020 %>%
  filter(shotType == "TIP")
wristshot <- shots2020 %>%
  filter(shotType == "WRIST")
wrap <- shots2020 %>%
  filter(shotType == "WRAP")
forward <- shots2020 %>%
  filter(Position == "F")
defense <- shots2020 %>%
  filter(Position == "D")


```

class: left, top
## NHL Shots Data
* <p> 
* <p> 
* <p> 
* <p> 

---

## Calibration of Moneypuck xG Model

--

```{r echo = FALSE}
shots2020 %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---
# Calibration of xG Model for Home and Away Teams

### Home
```{r echo = FALSE, figures-side, fig.show="hold", out.width = "50%"}
hometeam %>%
  mutate(
    bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2) +
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") +
    labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")

awayteam %>%
  mutate(
    bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2) +
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") +
    labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---

## Calibration of xG Model by Situation 

### Even Strength
--
```{r}
evenstrength %>%
  mutate(bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.1, y = -0.01),
            size = 2) +
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") +
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---
### Powerplay and Penalty Kill

```{r, figures-side, fig.show="hold", out.width = "50%"}
powerplay %>%
  mutate(bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2) +
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") +
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")

penaltykill %>%
  mutate(bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.07, y = -0.02),
            size = 2) +
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") +
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---
## Calibration of xG Model by Shot Type

# Wristshot and Slapshot

```{r, figures-side, fig.show="hold", out.width = "50%"}
wristshot %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")

slapshot %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---
### Backhand and Snapshot

```{r, figures-side, fig.show="hold", out.width = "50%"}
backhand %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")

snapshot %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---
### Tip and Wraparound
```{r, figures-side, fig.show="hold", out.width = "50%"}
tip %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")

wrap %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---
### Deflection

```{r}
deflection %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---

## Position
### Forwards vs Defense

```{r, figures-side, fig.show="hold", out.width = "50%"}
forward %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")

defense %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---
# Handedness 

---

## Basic xG Model with Logistic Regression

---

## Rebound Probability Model with Logistic Regression

---

## xG Coefficient Trends Over Time

---

## Rebound Model Coefficient Trends Over Time

