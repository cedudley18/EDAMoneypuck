---
title: "Initial Tasks with Moneypuck Data"

author: 
  - "Claire Dudley, Devin Basley"
  - "Ruby Wu, Sara Armstrong" 
date: 'July 1st, 2021'
output: 
  xaringan::moon_reader:
    css: xaringan-themer.css
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  
    fig.width = 9, fig.height = 3.5, fig.retina = 3,
    out.width = "100%",
    cache = FALSE,
    echo = FALSE,
    message = FALSE,
    warning = FALSE,
    fig.show = TRUE,
    hiline = TRUE)
```

```{r xaringan-themer, include = FALSE, warning = FALSE}
library(xaringanthemer)
style_mono_accent(base_color = "#808080",
  white_color = "#FFFFFF",
  background_color = "#fff7e6",
  base_font_size = "24px"
)
```


## Bootstrapping
 - Any test or metric that uses sampling with replacement
 - Assigns measures of accuracy to sample estimates
 - Allows estimation of sampling distribution of any statistic using random sampling
 
---


```{r include = FALSE, warning = FALSE}
# for setting up data
library(tidyverse)
library(data.table)
shots2020 <- read_csv("../CMSACamp_NHL_Project/data/shots_2020.csv")
shots0719 <- read.csv("../CMSACamp_NHL_Project/data/shots_2007-2019.csv")
```

```{r}
shots2020 <-
  shots2020 %>%
  mutate(Position = ifelse(playerPositionThatDidEvent == "D", "D", "F"))
```


```{r include = FALSE, warning = FALSE}
# Subsets for calibration
hometeam <- subset(shots2020, team == "HOME")
awayteam <- subset(shots2020, team = "AWAY")
evenstrength <-  shots2020 %>%
  filter(homeSkatersOnIce == 5,
        awaySkatersOnIce == 5)
powerplay <-  shots2020 %>%
  filter(homeSkatersOnIce == 5,
         awaySkatersOnIce == 4,
         isHomeTeam == 1)
penaltykill <-  shots2020 %>%
  filter(homeSkatersOnIce == 4,
         awaySkatersOnIce == 5,
         isHomeTeam == 1)
backhand <- shots2020 %>%
  filter(shotType == "BACK")
deflection <- shots2020 %>%
  filter(shotType == "DEFL")
slapshot <- shots2020 %>%
  filter(shotType == "SLAP")
snapshot <- shots2020 %>%
  filter(shotType == "SNAP")
tip <- shots2020 %>%
  filter(shotType == "TIP")
wristshot <- shots2020 %>%
  filter(shotType == "WRIST")
wrap <- shots2020 %>%
  filter(shotType == "WRAP")
forward <- shots2020 %>%
  filter(Position == "F")
defense <- shots2020 %>%
  filter(Position == "D")


```

class: left, top
## NHL Shots Data
* <p> Exclusively 2021 season data </p>
* <p> Excludes strikes and balls </p>
* <p> Examining a subset of the game of baseball </p>
* <p> Exploring different conditions influence outcomes </p>

???
* The title of our data set is batted balls and it is focused on only the plays
in baseball that are hit. Aka we are not looking at balls and strikes  
* The natural direction of our exploration is how the play develops based around 
different game conditions and this acts as the umbrella of our exploration    
* Notably this subset of the game precludes any analysis on batting or pitching 
efficiency and rather directs us to examine post hit features of the game

---

## Calibration of Moneypuck xG Model

--

```{r echo = FALSE}
shots2020 %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---

## Calibration of xG Model for Home and Away Teams

--
```{r echo = FALSE}
hometeam_c <- hometeam %>%
  mutate(
    bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2) +
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") +
    labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```



```{r echo = FALSE,fig.show="hold",fig.height=3.5, fig.width = 3}
awayteam_c <- awayteam %>%
  mutate(
    bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2) +
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") +
    labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")

par(mfrow=c(1,2))
awayteam_c
hometeam_c
```

---

layout: true
### Calibration of xG Model by Situation 
---

### Even Strength
--
```{r fig.height=3.5, fig.width = 5.5}
evenstrength %>%
  mutate(bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.1, y = -0.01),
            size = 2) +
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") +
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---


```{r fig.height=3.5, fig.width = 5.5}
powerplay %>%
  mutate(bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2) +
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") +
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts",
       title="Powerplay")
```

---

### Penalty Kill

```{r}
penaltykill %>%
  mutate(bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.07, y = -0.02),
            size = 2) +
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") +
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---


layout: true
## Calibration of xG Model by Shot Type
---

### Wristshot

```{r}
wristshot %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```


---


```{r}
slapshot %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```


---

```{r}
backhand %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```


---

```{r}
snapshot %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---

```{r}
tip %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---

```{r}
wrap %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```


---

```{r}
deflection %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```


---

layout: true
## Position
---

### Forwards

```{r}
forward %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```

---

### Defense
```{r}
defense %>%
  mutate(
         bin_pred_prob = round(xGoal / 0.05) * 0.05) %>%
  group_by(bin_pred_prob) %>%
  summarize(n_attempts = n(),
            bin_actual_prob = mean(goal)) %>%
  ggplot(aes(x = bin_pred_prob, y = bin_actual_prob)) + 
  geom_point(aes(size = n_attempts)) + 
  geom_text(aes(label = n_attempts),
            position = position_nudge(x = 0.05, y = -0.05),
            size = 2)+
  geom_smooth(method = "loess", se = FALSE) + 
  geom_abline(intercept = 0, slope = 1, color = "darkred",
              linetype = "dashed") + 
  theme_bw() + 
  coord_equal() + 
  scale_x_continuous(limits = c(0,1)) +
  scale_y_continuous(limits = c(0, 1)) + 
  theme(legend.position = "bottom") + 
  labs(x = "Predicted Probability",
       y = "Actual Probability",
       size = "Number of Attempts")
```


---

layout: false

## Basic xG Model with Logistic Regression

---

## Rebound Probability Model with Logistic Regression

---

### xG Coefficient Trends Over Time

```{r echo=FALSE}

shots1019 <- shots0719 %>% 
  filter(season>2009)

recent_season <- rbind(select(shots1019,season,shotAngleAdjusted,arenaAdjustedShotDistance,goal,shotGeneratedRebound),select(shots2020,season,shotAngleAdjusted,arenaAdjustedShotDistance,goal,shotGeneratedRebound))

dat_list = split(recent_season, recent_season$season)
```

```{r echo=FALSE,fig.align="center", fig.show="hold", out.width="80%"}
init_logit <- map(dat_list, ~glm(goal ~                        shotAngleAdjusted+arenaAdjustedShotDistance,
                                 data = .x,
                                 family = binomial("logit")) )

distance<- rep(NA,11)
angle<-rep(NA,11)

for (i in 1:11){
  distance[i] <- init_logit[[i]]$coefficients[3]
  angle[i]<- init_logit[[i]]$coefficients[2]
}

coefficients<- data.frame(season= as.factor(2010:2020) ,distance_c= distance, angle_c = angle)

ggplot(coefficients,aes(x=season,y=distance_c))+
  geom_point()+
  geom_line(aes(group=1))+
  labs(title = "Distance")+
  theme_bw()
  
ggplot(coefficients,aes(x=season,y=angle_c))+
  geom_point()+
  geom_line(aes(group=1))+
  labs(title = "Angle")+
  theme_bw()

```






---

### Rebound Coefficient Trends Over Time


```{r echo=FALSE,fig.align="center", fig.show="hold", out.width="80%"}

init_logit <- map(dat_list, ~glm(shotGeneratedRebound ~                        shotAngleAdjusted+arenaAdjustedShotDistance,
                                 data = .x,
                                 family = binomial("logit")) )

distance<- rep(NA,11)
angle<-rep(NA,11)

for (i in 1:11){
  distance[i] <- init_logit[[i]]$coefficients[3]
  angle[i]<- init_logit[[i]]$coefficients[2]
}

coefficients<- data.frame(season= as.factor(2010:2020) ,distance_c= distance, angle_c = angle)

ggplot(coefficients,aes(x=season,y=distance_c))+
  geom_point()+
  geom_line(aes(group=1))+
  labs(title = "Distance")+
  theme_bw()
  
ggplot(coefficients,aes(x=season,y=angle_c))+
  geom_point()+
  geom_line(aes(group=1))+
  labs(title = "Angle")+
  theme_bw()
```

